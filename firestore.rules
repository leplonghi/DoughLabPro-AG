rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if specific fields are NOT being modified in an update
    function notModifying(fields) {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(fields);
    }

    // --- User Data (Existing Modules) ---
    // Secure the users collection and its subcollections (batches, ovens, etc.)
    // This ensures compatibility with existing modules while removing the insecure global wildcard.
    match /users/{userId} {
      allow read, write: if isOwner(userId);

      match /batches/{batchId} {
        allow read, write: if isOwner(userId);
      }
      match /ovens/{ovenId} {
        allow read, write: if isOwner(userId);
      }
      match /levains/{levainId} {
        allow read, write: if isOwner(userId);
      }
      match /goals/{goalId} {
        allow read, write: if isOwner(userId);
      }
      match /test_series/{seriesId} {
        allow read, write: if isOwner(userId);
      }
      match /user_styles/{styleId} {
        allow read, write: if isOwner(userId);
      }
      // Catch-all for any other future user subcollections
      match /{collection}/{doc} {
        allow read, write: if isOwner(userId);
      }
    }

    // --- Community Module ---

    // Posts
    match /community_posts/{postId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() 
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.createdAt == request.time;
        // Note: Rate limiting (max 5 posts/hour) requires Cloud Functions or a separate user_stats document.

      allow update: if isOwner(resource.data.uid)
        // Requirement: Users may NOT modify likes, comments or clones counters manually.
        // These should be updated via Cloud Functions in response to sub-collection events.
        && notModifying(['likes', 'comments', 'clones']);

      allow delete: if isOwner(resource.data.uid);
    }

    // Comments
    match /community_comments/{commentId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.text is string
        && request.resource.data.text.size() > 0
        && request.resource.data.text.size() <= 500;
        // Note: Rate limiting (max 20 comments/hour) requires Cloud Functions.

      allow update, delete: if isOwner(resource.data.uid);
    }

    // Likes
    match /community_likes/{likeId} {
      allow read: if isAuthenticated();
      
      // Enforce uniqueness by ID format: postId_userId
      allow create: if isAuthenticated() 
        && request.resource.data.uid == request.auth.uid
        && likeId == request.resource.data.postId + "_" + request.auth.uid;
        
      allow delete: if isOwner(resource.data.uid);
    }

    // Clones
    match /community_clones/{cloneId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
      allow delete: if isOwner(resource.data.uid);
    }

    // Follows
    match /community_follows/{followId} {
      allow read: if isAuthenticated();
      
      // Enforce uniqueness by ID format: followerUid_targetUid
      allow create: if isAuthenticated() 
        && request.resource.data.followerUid == request.auth.uid
        && followId == request.resource.data.followerUid + "_" + request.resource.data.targetUid;
        
      allow delete: if isOwner(resource.data.followerUid);
    }

    // Leaderboard
    match /leaderboard/{userId} {
      allow read: if isAuthenticated();
      allow write: if false; // Managed by Cloud Functions
    }

    // Rankings
    match /community_rankings/{rankingId} {
      allow read: if isAuthenticated();
      // Requirement: Rankings must be read-only (written only by Cloud Functions)
      allow write: if false; 
    }
  }
}